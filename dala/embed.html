<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Embed Card — Spotynif Tool</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" href="dala/favicon.svg" />
  <meta name="description" content="Spotify Card by Spotynif Tool">
  <style>
    html, body, #embedroot {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    
    body {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px;
      background: transparent;
    }
    
    #embedroot {
      width: 100%;
      max-width: 420px;
    }
  </style>
</head>
<body>
  <div id="embedroot"></div>

  <script>
    (function() {
      const urlparams = new URLSearchParams(location.search);
      const discordid = urlparams.get('id') || urlparams.get('uid') || '';
      const showartist = urlparams.get('showArtist') !== 'false';
      const showprogress = urlparams.get('showProgress') !== 'false';
      const showalbum = urlparams.get('showAlbum') !== 'false';
      const showusername = urlparams.get('showUsername') !== 'false';
      const cardtheme = urlparams.get('theme') === 'light' ? 'light' : 'dark';
      const customtxt = urlparams.get('custom') || '';
      const customsongcolor = urlparams.get('songColor') || '';
      const customartistcolor = urlparams.get('artistColor') || '';
      const customusernamecolor = urlparams.get('usernameColor') || '';
      const customprogressbgcolor = urlparams.get('progressBgColor') || '';
      const customprogressfillcolor = urlparams.get('progressFillColor') || '';
      const customprogressendcolor = urlparams.get('progressEndColor') || '';

      if (cardtheme === 'light') {
        document.body.classList.add('card-light');
      }

      const documentroot = document.documentElement;
      if (customsongcolor) documentroot.style.setProperty('--song-color', customsongcolor);
      if (customartistcolor) documentroot.style.setProperty('--artist-color', customartistcolor);
      if (customusernamecolor) documentroot.style.setProperty('--username-color', customusernamecolor);
      if (customprogressbgcolor) documentroot.style.setProperty('--progress-bg-color', customprogressbgcolor);
      if (customprogressfillcolor) documentroot.style.setProperty('--progress-fill-color', customprogressfillcolor);
      if (customprogressendcolor) documentroot.style.setProperty('--progress-fill-end-color', customprogressendcolor);
      
      const rootcontainer = document.getElementById('embedroot');

      if (!discordid) {
        rootcontainer.innerHTML = '<div class="player"><div class="meta"><div class="song">Missing ID</div><div class="artist">Please provide a Discord user ID</div></div></div>';
        return;
      }

      const formatduration = ms => {
        if (!ms) return '0:00';
        const seconds = Math.floor(ms / 1000);
        const minutes = Math.floor(seconds / 60);
        const remainingsecs = String(seconds % 60).padStart(2, '0');
        return `${minutes}:${remainingsecs}`;
      };

      let pollingInterval = null;
      let presencedata = null;
      let frameanimation = null;

      function getprogress(spotifydata) {
        if (!spotifydata || !spotifydata.timestamps) return null;
        const starttime = spotifydata.timestamps.start;
        const endtime = spotifydata.timestamps.end;
        if (!starttime || !endtime) return null;
        
        const totaldur = endtime - starttime;
        const currentelapsed = Date.now() - starttime;
        const progresspct = Math.max(0, Math.min(1, currentelapsed / totaldur));
        
        return { 
          elapsed: currentelapsed, 
          duration: totaldur, 
          percent: progresspct 
        };
      }

      function drawplayer() {
        if (frameanimation) cancelAnimationFrame(frameanimation);
        if (!presencedata) {
          rootcontainer.innerHTML = '<div class="player"><div class="meta"><div class="song">No data</div><div class="artist">Connecting...</div></div></div>';
          return;
        }

        const spotifyinfo = presencedata.spotify ?? null;
        const discorduser = presencedata.discord_user?.username ?? null;
        rootcontainer.innerHTML = '';
        const playercard = document.createElement('div');
        playercard.className = 'player';
        
        if (showalbum && spotifyinfo?.album_art_url) {
          const albumart = document.createElement('img');
          albumart.className = 'art';
          albumart.src = spotifyinfo.album_art_url;
          albumart.onerror = () => albumart.style.display = 'none';
          playercard.appendChild(albumart);
        }
        
        const trackinfo = document.createElement('div');
        trackinfo.className = 'meta';
        const tracktitle = document.createElement('div');
        tracktitle.className = 'song';
        tracktitle.textContent = spotifyinfo?.song ?? '— Not listening';
        trackinfo.appendChild(tracktitle);
        
        if (showartist && spotifyinfo?.artist) {
          const trackartist = document.createElement('div');
          trackartist.className = 'artist';
          trackartist.textContent = spotifyinfo.artist;
          trackinfo.appendChild(trackartist);
        }
        
        if (showusername && discorduser) {
          const username = document.createElement('div');
          username.className = 'username';
          username.textContent = `@${discorduser}`;
          trackinfo.appendChild(username);
        }
        
        if (customtxt) {
          const custommsg = document.createElement('div');
          custommsg.className = 'custom-text';
          custommsg.textContent = customtxt;
          trackinfo.appendChild(custommsg);
        }
        
        if (showprogress && spotifyinfo) {
          const timedisplay = document.createElement('div');
          timedisplay.className = 'time-row';
          const currenttime = document.createElement('span');
          const totaltime = document.createElement('span');
          currenttime.textContent = '--:--';
          totaltime.textContent = '--:--';
          timedisplay.appendChild(currenttime);
          timedisplay.appendChild(totaltime);
          
          const progressbar = document.createElement('div');
          progressbar.className = 'progress-bar';
          const progressfill = document.createElement('div');
          progressfill.className = 'progress-fill';
          progressbar.appendChild(progressfill);
          trackinfo.appendChild(timedisplay);
          trackinfo.appendChild(progressbar);

          function updateprogress() {
            const progress = getprogress(spotifyinfo);
            if (progress && spotifyinfo.timestamps) {
              currenttime.textContent = formatduration(progress.elapsed);
              totaltime.textContent = formatduration(progress.duration);
              progressfill.style.transform = `scaleX(${progress.percent})`;
            } else {
              currenttime.textContent = '--:--';
              totaltime.textContent = '--:--';
              progressfill.style.transform = 'scaleX(0)';
            }
            frameanimation = requestAnimationFrame(updateprogress);
          }
          updateprogress();
        }

        playercard.appendChild(trackinfo);
        rootcontainer.appendChild(playercard);
      }

      async function getinitialdata() {
        try {
          const response = await fetch(`https://api.lanyard.rest/v1/users/${discordid}`);
          const jsondata = await response.json();
          if (jsondata && jsondata.success && jsondata.data) {
            presencedata = jsondata.data;
            drawplayer();
          } else {
            console.warn('Failed to get initial data:', jsondata);
          }
        } catch (error) {
          console.warn('Initial fetch failed:', error);
        }
      }

      function startPolling() {
        // Start HTTP polling instead of WebSocket
        getinitialdata();
        
        pollingInterval = setInterval(async () => {
          try {
            const response = await fetch(`https://api.lanyard.rest/v1/users/${discordid}`);
            const jsondata = await response.json();
            if (jsondata && jsondata.success && jsondata.data) {
              presencedata = jsondata.data;
              drawplayer();
            }
          } catch (error) {
            console.warn('Polling update failed:', error);
          }
        }, 15000); // Poll every 15 seconds
      }

      startPolling();

      window.addEventListener('beforeunload', () => {
        if (pollingInterval) {
          clearInterval(pollingInterval);
        }
        if (frameanimation) cancelAnimationFrame(frameanimation);
      });

    })();
  </script>
</body>
</html>
