<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Embed Card — Spotynif Tool</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" href="favicon.svg" />
  <meta name="description" content="Spotify Card by Spotynif Tool">
  <style>
    html, body, #embedroot {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    
    body {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px;
      background: transparent;
    }
    
    #embedroot {
      width: 100%;
      max-width: 420px;
    }
  </style>
</head>
<body>
  <div id="embedroot"></div>

  <script>
    (function() {
      const urlparams = new URLSearchParams(location.search);
      const discordid = urlparams.get('id') || urlparams.get('uid') || '';
      const showartist = urlparams.get('showArtist') !== 'false';
      const showprogress = urlparams.get('showProgress') !== 'false';
      const showalbum = urlparams.get('showAlbum') !== 'false';
      const showusername = urlparams.get('showUsername') !== 'false';
      const cardtheme = urlparams.get('theme') === 'light' ? 'light' : 'dark';
      const customtxt = urlparams.get('custom') || '';
      const customsongcolor = urlparams.get('songColor') || '';
      const customartistcolor = urlparams.get('artistColor') || '';
      const customusernamecolor = urlparams.get('usernameColor') || '';
      const customprogressbgcolor = urlparams.get('progressBgColor') || '';
      const customprogressfillcolor = urlparams.get('progressFillColor') || '';
      const customprogressendcolor = urlparams.get('progressEndColor') || '';

      if (cardtheme === 'light') {
        document.body.classList.add('card-light');
      }

      const documentroot = document.documentElement;
      if (customsongcolor) documentroot.style.setProperty('--song-color', customsongcolor);
      if (customartistcolor) documentroot.style.setProperty('--artist-color', customartistcolor);
      if (customusernamecolor) documentroot.style.setProperty('--username-color', customusernamecolor);
      if (customprogressbgcolor) documentroot.style.setProperty('--progress-bg-color', customprogressbgcolor);
      if (customprogressfillcolor) documentroot.style.setProperty('--progress-fill-color', customprogressfillcolor);
      if (customprogressendcolor) documentroot.style.setProperty('--progress-fill-end-color', customprogressendcolor);
      const rootcontainer = document.getElementById('embedroot');

      if (!discordid) {
        rootcontainer.innerHTML = '<div class="player"><div class="meta"><div class="song">Missing ID</div><div class="artist">Please provide a Discord user ID</div></div></div>';
        return;
      }

      const formatduration = ms => {
        if (!ms) return '0:00';
        const seconds = Math.floor(ms / 1000);
        const minutes = Math.floor(seconds / 60);
        const remainingsecs = String(seconds % 60).padStart(2, '0');
        return `${minutes}:${remainingsecs}`;
      };

      let presencedata = null;
      let frameanimation = null;
      let refreshinterval = null;

      function getprogress(spotifydata) {
        if (!spotifydata || !spotifydata.timestamps) return null;
        const starttime = spotifydata.timestamps.start;
        const endtime = spotifydata.timestamps.end;
        if (!starttime || !endtime) return null;
        
        const totaldur = endtime - starttime;
        const currentelapsed = Date.now() - starttime;
        const progresspct = Math.max(0, Math.min(1, currentelapsed / totaldur));
        
        return { 
          elapsed: currentelapsed, 
          duration: totaldur, 
          percent: progresspct 
        };
      }

      let playercard = null;
      let albumart = null;
      let tracktitle = null;
      let trackartist = null;
      let username = null;
      let custommsg = null;
      let currenttime = null;
      let totaltime = null;
      let progressfill = null;
      let lastspotifydata = null;

      function createplayer() {
        if (playercard) return;
        
        rootcontainer.innerHTML = '';
        playercard = document.createElement('div');
        playercard.className = 'player';
        
        if (showalbum) {
          albumart = document.createElement('img');
          albumart.className = 'art';
          albumart.style.display = 'none';
          albumart.onerror = () => albumart.style.display = 'none';
          playercard.appendChild(albumart);
        }
        
        const trackinfo = document.createElement('div');
        trackinfo.className = 'meta';
        
        tracktitle = document.createElement('div');
        tracktitle.className = 'song';
        tracktitle.textContent = '— Not listening';
        trackinfo.appendChild(tracktitle);
        
        if (showartist) {
          trackartist = document.createElement('div');
          trackartist.className = 'artist';
          trackartist.style.display = 'none';
          trackinfo.appendChild(trackartist);
        }
        
        if (showusername) {
          username = document.createElement('div');
          username.className = 'username';
          username.style.display = 'none';
          trackinfo.appendChild(username);
        }
        
        if (customtxt) {
          custommsg = document.createElement('div');
          custommsg.className = 'custom-text';
          custommsg.textContent = customtxt;
          trackinfo.appendChild(custommsg);
        }
        
        if (showprogress) {
          const timedisplay = document.createElement('div');
          timedisplay.className = 'time-row';
          currenttime = document.createElement('span');
          totaltime = document.createElement('span');
          currenttime.textContent = '--:--';
          totaltime.textContent = '--:--';
          timedisplay.appendChild(currenttime);
          timedisplay.appendChild(totaltime);
          
          const progressbar = document.createElement('div');
          progressbar.className = 'progress-bar';
          progressfill = document.createElement('div');
          progressfill.className = 'progress-fill';
          progressbar.appendChild(progressfill);
          trackinfo.appendChild(timedisplay);
          trackinfo.appendChild(progressbar);
        }

        playercard.appendChild(trackinfo);
        rootcontainer.appendChild(playercard);
      }

      function updateplayer() {
        if (!playercard) createplayer();
        if (!presencedata) return;

        const spotifyinfo = presencedata.spotify ?? null;
        const discorduser = presencedata.discord_user?.username ?? null;
        
        if (tracktitle) {
          tracktitle.textContent = spotifyinfo?.song ?? '— Not listening';
        }
        
        if (trackartist && showartist) {
          if (spotifyinfo?.artist) {
            trackartist.textContent = spotifyinfo.artist;
            trackartist.style.display = 'block';
          } else {
            trackartist.style.display = 'none';
          }
        }
        
        if (albumart && showalbum) {
          if (spotifyinfo?.album_art_url) {
            albumart.src = spotifyinfo.album_art_url;
            albumart.style.display = 'block';
          } else {
            albumart.style.display = 'none';
          }
        }
        
        if (username && showusername) {
          if (discorduser) {
            username.textContent = `@${discorduser}`;
            username.style.display = 'block';
          } else {
            username.style.display = 'none';
          }
        }
        
        lastspotifydata = spotifyinfo;
      }

      function updateprogress() {
        if (!showprogress || !lastspotifydata || !currenttime || !totaltime || !progressfill) {
          if (frameanimation) frameanimation = requestAnimationFrame(updateprogress);
          return;
        }
        
        const progress = getprogress(lastspotifydata);
        if (progress && lastspotifydata.timestamps) {
          currenttime.textContent = formatduration(progress.elapsed);
          totaltime.textContent = formatduration(progress.duration);
          progressfill.style.transform = `scaleX(${progress.percent})`;
        } else {
          currenttime.textContent = '--:--';
          totaltime.textContent = '--:--';
          progressfill.style.transform = 'scaleX(0)';
        }
        frameanimation = requestAnimationFrame(updateprogress);
      }

      function drawplayer() {
        updateplayer();
        if (frameanimation) cancelAnimationFrame(frameanimation);
        frameanimation = requestAnimationFrame(updateprogress);
      }

      async function fetchdata() {
        try {
          const response = await fetch(`https://api.lanyard.rest/v1/users/${discordid}`);
          const jsondata = await response.json();
          if (jsondata && jsondata.success && jsondata.data) {
            presencedata = jsondata.data;
            drawplayer();
          } else {
            if (!playercard) {
              rootcontainer.innerHTML = '<div class="player"><div class="meta"><div class="song">User not found</div><div class="artist">Check Discord ID</div></div></div>';
            }
          }
        } catch (error) {
          console.warn('fetch failed:', error);
          if (!playercard) {
            rootcontainer.innerHTML = '<div class="player"><div class="meta"><div class="song">Connection error</div><div class="artist">Retrying...</div></div></div>';
          }
        }
      }

      function startrefreshloop() {
        fetchdata();
        refreshinterval = setInterval(fetchdata, 10000);
      }

      function stoprefreshloop() {
        if (refreshinterval) {
          clearInterval(refreshinterval);
          refreshinterval = null;
        }
      }

      startrefreshloop();
      window.addEventListener('beforeunload', () => {
        stoprefreshloop();
        if (frameanimation) cancelAnimationFrame(frameanimation);
      });

    })();
  </script>
</body>
</html>
