<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>spotynif api</title>
  <meta name="description" content="spotynif api endpoint">
  <style>
    body {
      font-family: 'Monaco', 'Consolas', monospace;
      background: #000;
      color: #0f0;
      margin: 0;
      padding: 20px;
      line-height: 1.4;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    pre {
      background: #111;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 20px;
      overflow-x: auto;
      white-space: pre-wrap;
    }
    .error {
      color: #f44;
    }
    .loading {
      color: #fa0;
    }
    .header {
      text-align: center;
      margin-bottom: 20px;
      color: #fff;
    }
    .endpoint-info {
      background: #111;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      color: #ccc;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>spotynif api</h1>
      <p>real-time discord spotify data</p>
    </div>
    <div class="endpoint-info">
      <strong>endpoint:</strong> /api?id=YOUR_DISCORD_ID<br>
      <strong>method:</strong> GET<br>
      <strong>format:</strong> JSON<br>
      <strong>cors:</strong> enabled
    </div>
    <pre id="output">loading...</pre>
  </div>

  <script>
    (async function() {
      const urlparams = new URLSearchParams(location.search);
      const discordid = urlparams.get('id') || urlparams.get('uid') || '';
      const output = document.getElementById('output');

      // Set CORS headers
      if (window.parent === window) {
        // Only set headers if we're not in an iframe
        try {
          document.addEventListener('DOMContentLoaded', () => {
            const meta = document.createElement('meta');
            meta.httpEquiv = 'Access-Control-Allow-Origin';
            meta.content = '*';
            document.head.appendChild(meta);
          });
        } catch (e) {
          // Ignore errors in setting headers
        }
      }

      function formatjson(obj) {
        return JSON.stringify(obj, null, 2);
      }

      function createresponse(success, data = null, error = null) {
        const response = {
          success: success,
          timestamp: new Date().toISOString(),
          endpoint: '/api',
          source: 'spotynif'
        };

        if (success && data) {
          response.data = data;
        }

        if (!success && error) {
          response.error = error;
        }

        return response;
      }

      if (!discordid) {
        const errorresponse = createresponse(false, null, {
          code: 'MISSING_ID',
          message: 'Discord user ID is required',
          usage: 'GET /api?id=YOUR_DISCORD_ID'
        });
        output.innerHTML = formatjson(errorresponse);
        output.className = 'error';
        return;
      }

      // Validate Discord ID format
      if (!/^\d{17,19}$/.test(discordid)) {
        const errorresponse = createresponse(false, null, {
          code: 'INVALID_ID',
          message: 'Invalid Discord ID format',
          provided: discordid,
          expected: '17-19 digit number'
        });
        output.innerHTML = formatjson(errorresponse);
        output.className = 'error';
        return;
      }

      output.className = 'loading';

      try {
        const response = await fetch(`https://api.lanyard.rest/v1/users/${discordid}`);
        const lanyarddata = await response.json();

        if (!response.ok || !lanyarddata.success) {
          const errorresponse = createresponse(false, null, {
            code: 'USER_NOT_FOUND',
            message: 'Discord user not found or not monitored by Lanyard',
            discord_id: discordid,
            lanyard_status: lanyarddata?.error || 'unknown'
          });
          output.innerHTML = formatjson(errorresponse);
          output.className = 'error';
          return;
        }

        const userdata = lanyarddata.data;
        const spotifyinfo = userdata.spotify;
        const discorduser = userdata.discord_user;
        
        // Build clean API response
        const apidata = {
          discord: {
            id: discorduser.id,
            username: discorduser.username,
            discriminator: discorduser.discriminator,
            global_name: discorduser.global_name || null,
            avatar: discorduser.avatar ? {
              id: discorduser.avatar,
              url: `https://cdn.discordapp.com/avatars/${discorduser.id}/${discorduser.avatar}.png`
            } : null,
            status: userdata.discord_status,
            activities: userdata.activities?.map(activity => ({
              name: activity.name,
              type: activity.type,
              state: activity.state || null,
              details: activity.details || null
            })) || []
          },
          spotify: spotifyinfo ? {
            listening: true,
            song: spotifyinfo.song,
            artist: spotifyinfo.artist,
            album: spotifyinfo.album,
            album_art: spotifyinfo.album_art_url,
            track_id: spotifyinfo.track_id,
            timestamps: {
              start: spotifyinfo.timestamps.start,
              end: spotifyinfo.timestamps.end,
              duration: spotifyinfo.timestamps.end - spotifyinfo.timestamps.start,
              elapsed: Date.now() - spotifyinfo.timestamps.start,
              remaining: spotifyinfo.timestamps.end - Date.now(),
              progress_percent: Math.round(((Date.now() - spotifyinfo.timestamps.start) / (spotifyinfo.timestamps.end - spotifyinfo.timestamps.start)) * 100)
            }
          } : {
            listening: false,
            song: null,
            artist: null,
            album: null,
            album_art: null,
            track_id: null,
            timestamps: null
          },
          kv: userdata.kv || {},
          last_updated: userdata.last_updated || null
        };

        const successresponse = createresponse(true, apidata);
        output.innerHTML = formatjson(successresponse);
        output.className = '';

        // Auto-refresh every 10 seconds
        setTimeout(() => {
          location.reload();
        }, 10000);

      } catch (error) {
        const errorresponse = createresponse(false, null, {
          code: 'FETCH_ERROR',
          message: 'Failed to fetch user data',
          details: error.message,
          discord_id: discordid
        });
        output.innerHTML = formatjson(errorresponse);
        output.className = 'error';

        // Retry after 5 seconds on error
        setTimeout(() => {
          location.reload();
        }, 5000);
      }
    })();
  </script>
</body>
</html>
